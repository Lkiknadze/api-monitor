name: Driving License Exam Monitor

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  check-exams:
    runs-on: ubuntu-latest
    steps:
      - name: Check API for exam dates
        id: check
        continue-on-error: true
        run: |
          echo "üîç Checking for available exam dates..."
          response=$(curl -s --max-time 20 --connect-timeout 10 "https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15" 2>/dev/null || echo "TIMEOUT")
          if [ "$response" = "TIMEOUT" ]; then
            echo "‚ö†Ô∏è API timeout - will try again next run"
            echo "FOUND=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Response received (first 200 chars):"
          echo "$response" | head -c 200
          echo ""
          count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
          echo "Array length: $count"
          if [ "$count" -gt 0 ]; then
            echo "‚úÖ FOUND $count EXAM DATES!"
            echo "FOUND=true" >> $GITHUB_OUTPUT
            echo "COUNT=$count" >> $GITHUB_OUTPUT
          else
            echo "‚è≥ No exam dates available"
            echo "FOUND=false" >> $GITHUB_OUTPUT
          fi
      - name: Send Telegram notification
        if: steps.check.outputs.FOUND == 'true'
        run: |
          curl -s --max-time 10 -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" -d "text=üéâ EXAM DATES AVAILABLE!%0A%0AFound: ${{ steps.check.outputs.COUNT }} dates%0ACategory: 4, Center: 15%0A%0ALink: https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15%0A%0ABook now! üöó"
          echo "üì± Notification sent!"
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.FOUND }}" == "true" ]; then
            echo "‚úÖ Found ${{ steps.check.outputs.COUNT }} exam dates and notified!"
          else
            echo "‚è≥ No dates or timeout - will retry in 1 minute"
          fi
