name: Driving License Exam Monitor

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  check-exams:
    runs-on: ubuntu-latest
    steps:
      - name: Check API for exam dates
        id: check
        run: |
          echo "üîç Checking for available exam dates..."
          response=$(curl -s "https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15")
          echo "Full response:"
          echo "$response"
          count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
          echo "Array length: $count"
          if [ "$count" -gt 0 ]; then
            echo "‚úÖ FOUND $count EXAM DATES!"
            echo "FOUND=true" >> $GITHUB_OUTPUT
            echo "COUNT=$count" >> $GITHUB_OUTPUT
            echo "DATA<<EOF" >> $GITHUB_OUTPUT
            echo "$response" | jq '.' 2>/dev/null || echo "$response" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚è≥ No exam dates available"
            echo "FOUND=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification
        if: steps.check.outputs.FOUND == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" -d parse_mode="HTML" -d text="<b>üéâ EXAM DATES AVAILABLE!</b>%0A%0A<b>Found:</b> ${{ steps.check.outputs.COUNT }} available dates%0A<b>Category:</b> 4%0A<b>Center:</b> 15%0A%0A<b>Link:</b>%0Ahttps://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15%0A%0ACheck the link above to book your exam! üöó"
          echo "üì± Telegram notification sent!"

      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.FOUND }}" == "true" ]; then
            echo "‚úÖ SUCCESS: Found ${{ steps.check.outputs.COUNT }} exam dates and sent notification!"
          else
            echo "‚è≥ No dates available yet. Will check again in 1 minute..."
          fi
