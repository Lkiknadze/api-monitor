name: Driving License Exam Monitor

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  check-exams:
    runs-on: ubuntu-latest
    steps:
      - name: Check API via proxy
        id: check
        run: |
          echo "üîç Checking via proxy..."
          
          # Using a free CORS proxy to bypass geo-blocking
          response=$(curl -s --max-time 30 \
            "https://corsproxy.io/?https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15" \
            2>/dev/null || echo "FAILED")
          
          echo "Response: $response"
          
          if [ "$response" != "FAILED" ] && [ "$response" != "[]" ] && [ "$response" != "" ]; then
            count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
            echo "Count: $count"
            
            if [ "$count" -gt 0 ]; then
              echo "‚úÖ FOUND $count EXAM DATES!"
              echo "FOUND=true" >> $GITHUB_OUTPUT
              echo "COUNT=$count" >> $GITHUB_OUTPUT
            else
              echo "‚è≥ No dates yet"
              echo "FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚è≥ Empty or failed"
            echo "FOUND=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification
        if: steps.check.outputs.FOUND == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üéâ EXAM DATES AVAILABLE!%0A%0AFound: ${{ steps.check.outputs.COUNT }} dates%0ACategory: 4, Center: 15%0A%0ALink: https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15%0A%0ABook now! üöó"
          echo "üì± Sent!"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.FOUND }}" == "true" ]; then
            echo "‚úÖ Found and notified!"
          else
            echo "‚è≥ No dates - checking again in 1 minute"
          fi
