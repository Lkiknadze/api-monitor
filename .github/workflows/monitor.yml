name: Driving License Exam Monitor

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  check-exams:
    runs-on: ubuntu-latest
    steps:
      - name: Check API via proxy
        id: check
        run: |
          echo "üîç Checking Georgian driving exam API..."
          
          # Try AllOrigins proxy (free, no limits)
          response=$(curl -s --max-time 30 \
            "https://api.allorigins.win/raw?url=https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15" \
            2>/dev/null || echo "[]")
          
          echo "Response: $response"
          
          # Check if response is valid JSON array
          if echo "$response" | jq -e 'type == "array"' > /dev/null 2>&1; then
            count=$(echo "$response" | jq 'length')
            echo "Valid array with $count items"
            
            if [ "$count" -gt 0 ]; then
              echo "‚úÖ FOUND $count EXAM DATES!"
              echo "FOUND=true" >> $GITHUB_OUTPUT
              echo "COUNT=$count" >> $GITHUB_OUTPUT
            else
              echo "‚è≥ Array is empty (no dates yet)"
              echo "FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è Invalid response (not an array): $response"
            echo "FOUND=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification
        if: steps.check.outputs.FOUND == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üéâ EXAM DATES AVAILABLE!%0A%0AFound: ${{ steps.check.outputs.COUNT }} dates%0ACategory: 4, Center: 15%0A%0ALink: https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15%0A%0ABook now! üöó"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.FOUND }}" == "true" ]; then
            echo "‚úÖ Found ${{ steps.check.outputs.COUNT }} dates and notified!"
          else
            echo "‚è≥ No dates available - checking again in 1 minute"
          fi
