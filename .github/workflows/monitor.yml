name: Driving License Exam Monitor

on:
  schedule:
    # Check every 1 minute
    - cron: '* * * * *'
  
  # Allow manual running
  workflow_dispatch:

jobs:
  check-exams:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API for exam dates
        id: check
        run: |
          echo "üîç Checking for available exam dates..."
          
          # Call the Georgian driving license API
          response=$(curl -s "https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15")
          
          echo "Full response:"
          echo "$response"
          
          # Count array length using jq (JSON processor)
          count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
          
          echo "Array length: $count"
          
          # Check if we have data
          if [ "$count" -gt 0 ]; then
            echo "‚úÖ FOUND $count EXAM DATES!"
            echo "FOUND=true" >> $GITHUB_OUTPUT
            echo "COUNT=$count" >> $GITHUB_OUTPUT
            
            # Save the data
            {
              echo "DATA<<EOF"
              echo "$response" | jq '.' 2>/dev/null || echo "$response"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "‚è≥ No exam dates available (array is empty or invalid)"
            echo "FOUND=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Telegram notification
        if: steps.check.outputs.FOUND == 'true'
        run: |
          # Create message
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>üéâ EXAM DATES AVAILABLE!</b>

<b>Found:</b> ${{ steps.check.outputs.COUNT }} available dates
<b>Category:</b> 4
<b>Center:</b> 15

<b>Link:</b>
https://api-bookings.sa.gov.ge/api/v1/DrivingLicensePracticalExams2/DrivingLicenseExamsDates2?CategoryCode=4&CenterId=15

Check the link above to book your exam! üöó"
          
          echo "üì± Telegram notification sent!"
      
      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.FOUND }}" == "true" ]; then
            echo "‚úÖ SUCCESS: Found ${{ steps.check.outputs.COUNT }} exam dates and sent notification!"
          else
            echo "‚è≥ No dates available yet. Will check again in 1 minute..."
          fi
